---
title: "Analysis of household consumption expenditure in the state of Karnataka: NSSO Consumer Expenditure Survey 2022-23"
output: beamer_presentation
---

```{r, include=FALSE}
options(tinytex.verbose = TRUE)
```

## Residential energy demand forecast

-   To create policy pathways towards net-zero emissions future in India, it is imperative to understand the residential energy demand and expenditure patterns of households.

-   It will help us in satisfying future energy demand and address affordability concerns as well.

-   However, direct measurement of household energy demand and income/expenditure levels is a tough task due to absence of credible source of unit-level database.

-   Household Consumption Expenditure Survey (2022-23) dataset published by Ministry of Statistics and Programme Implementation (MoPSI) provides us an alternative way of measuring household energy demand

## Household Consumption Expenditure Survey (2022-23)

-   The Household Consumption Expenditure Survey (HCES) is designed to collect information on consumption of goods and services by the households.

-   The survey also collects some auxiliary information on household characteristics and demographic particulars of the households.

-   Information collected in HCES is useful for understanding the consumption and expenditure pattern, standard of living and well-being of the households.

## Methodology

-   We pre-process and clean the dataset as per the methodology prescribed in <https://github.com/s7u512/NSSO_HCES_2022-23/tree/main/>.

-   Afterwards we select randomly the state of Karnataka to analyse the monthly per capital expenditure pattern of households in both urban and rural areas based on their expenditure quintiles.

-   We use the weighted values for processing the complex survey data.

## MPCE Analysis - Rural Karnataka

```{r, echo = FALSE, warning=FALSE, message=FALSE}


# Load necessary libraries
library(tidyverse) # for data manipulation
library(xtable)

# load data for MPCE
load("./DATA/MPCE.RData")

# MPCE CALCULATION ONLY FOR RURAL/URBAN
MPCE <- MPCE %>%
  mutate(Sector = if_else(Sector == 2, "Urban", "Rural"))

# filter for Karnataka
MPCE_Karnataka <- MPCE %>% filter(StateName == "Karnataka")

# filter for rural
MPCE_Karnataka_Rural <- MPCE_Karnataka %>% filter(Sector == "Rural")

# ordering by mpce
MPCE_Karnataka_Rural <- MPCE_Karnataka_Rural[order(MPCE_Karnataka_Rural$MPCE), ]


# Step 1: Ensure the data is sorted by MPCE
MPCE_Karnataka_Rural1 <- MPCE_Karnataka_Rural %>%
  arrange(MPCE)

# Step 2: Calculate cumulative estimated population
MPCE_Karnataka_Rural1 <- MPCE_Karnataka_Rural1 %>%
  mutate(cumulative_population = cumsum(Household.size.F * Weights))


# Step 3: Determine total population and quintile breakpoints
total_population_rural <- sum(MPCE_Karnataka_Rural1$Household.size.F * MPCE_Karnataka_Rural1$Weights)
quintile_breaks_rural <- seq(0, total_population_rural, length.out = 6)  # 5 quintiles = 6 breakpoints

# Step 4: Assign quintiles based on cumulative population
MPCE_Karnataka_Rural1 <- MPCE_Karnataka_Rural1 %>%
  mutate(quintile = cut(cumulative_population, breaks = quintile_breaks_rural, labels = 1:5, include.lowest = TRUE))


# Step 5: Verify the population distribution across quintiles
# population_by_quintile <- MPCE_Karnataka_Rural1 %>%
#   group_by(quintile) %>%
#   summarise(total_population = sum(Household.size.F * Weights))
# 
# Print the results to verify
# print(population_by_quintile)

# summary stats by quintile
mpce_by_quintile_rural <- MPCE_Karnataka_Rural1 %>%
  group_by(quintile) %>%
  summarise(
    min_MPCE = quantile(MPCE, probs = 0, weights = Weights),  # Minimum MPCE using weighted quantile
    avg_MPCE = sum(MPCE * Weights * Household.size.F)/sum(Weights * Household.size.F),
    max_MPCE = quantile(MPCE, probs = 1, weights = Weights),    # Maximum MPCE using weighted quantile
    avg_HH_size = sum(Household.size.F * Weights) / sum(Weights),  # Calculate average household size in each percentile
    total_population = sum(Household.size.F * Weights),  # Total population in each percentile
    weighted_num_households = sum(Weights)
  )

# Print the results
mpce_by_quintile_rural1 <- mpce_by_quintile_rural[, 1:4]

mpce_by_quintile_rural_pop <- mpce_by_quintile_rural[, c(1, 5:7)]

#print(xtable(mpce_by_quintile_rural1))
```

```{=latex}
\begin{table}[ht]
\centering
\begin{tabular}{lrrr}
  \hline
  quintile & min\_MPCE & avg\_MPCE & max\_MPCE \\ 
  \hline
  1 & 1156.08 & 2446.75 & 2927.38 \\ 
  2 & 2927.58 & 3238.08 & 3562.66 \\ 
  3 & 3562.94 & 3955.48 & 4358.83 \\ 
  4 & 4359.82 & 4880.44 & 5540.07 \\ 
  5 & 5540.70 & 7464.97 & 66635.26 \\ 
   \hline
\end{tabular}
\end{table}
```
## Population distribution - Rural Karnataka

```{r, echo = FALSE, warning=FALSE, message=FALSE}
colnames(mpce_by_quintile_rural_pop)[colnames(mpce_by_quintile_rural_pop) == "weighted_num_households"] <- "weighted_households"


#print(xtable(mpce_by_quintile_rural_pop))
```

```{=latex}
\begin{table}[ht]
\centering
\begin{tabular}{lrrr}
  \hline
 quintile & avg\_HH\_size & total\_population & weighted\_households \\ 
  \hline
  1 & 5.77 & 7492274.86 & 1297643.88 \\ 
  2 & 4.80 & 7491259.94 & 1562145.21 \\ 
  3 & 4.18 & 7497655.26 & 1793080.35 \\ 
  4 & 3.86 & 7494449.90 & 1939621.58 \\ 
  5 & 3.22 & 7496222.79 & 2330576.20 \\ 
   \hline
\end{tabular}
\end{table}
```
## MPCE Analysis - Urban Karnataka

```{r, echo = FALSE, warning=FALSE, message=FALSE}
# URBAN
# filter for urban
MPCE_Karnataka_Urban <- MPCE_Karnataka %>% filter(Sector == "Urban")

#ordering by mpce
MPCE_Karnataka_Urban <- MPCE_Karnataka_Urban[order(MPCE_Karnataka_Urban$MPCE), ]


# Step 1: Ensure the data is sorted by MPCE
MPCE_Karnataka_Urban1 <- MPCE_Karnataka_Urban %>%
  arrange(MPCE)

# Step 2: Calculate cumulative estimated population
MPCE_Karnataka_Urban1 <- MPCE_Karnataka_Urban1 %>%
  mutate(cumulative_population = cumsum(Household.size.F * Weights))

# Step 3: Determine total population and quintile breakpoints
total_population_urban <- sum(MPCE_Karnataka_Urban1$Household.size.F * MPCE_Karnataka_Urban1$Weights)
quintile_breaks_urban <- seq(0, total_population_urban, length.out = 6)  # 5 quintiles = 6 breakpoints

# Step 4: Assign quintiles based on cumulative population
MPCE_Karnataka_Urban1 <- MPCE_Karnataka_Urban1 %>%
  mutate(quintile = cut(cumulative_population, breaks = quintile_breaks_urban, labels = 1:5, include.lowest = TRUE))


# Step 5: Verify the population distribution across quintiles
# population_by_quintile <- MPCE_Karnataka_Urban1 %>%
#   group_by(quintile) %>%
#   summarise(total_population = sum(Household.size.F * Weights))
# 
# Print the results to verify
# print(population_by_quintile)

# summary stats by quintile
mpce_by_quintile_urban <- MPCE_Karnataka_Urban1 %>%
  group_by(quintile) %>%
  summarise(
    min_MPCE = quantile(MPCE, probs = 0, weights = Weights),  # Minimum MPCE using weighted quantile
    avg_MPCE = sum(MPCE * Weights * Household.size.F)/sum(Weights * Household.size.F),
    max_MPCE = quantile(MPCE, probs = 1, weights = Weights),    # Maximum MPCE using weighted quantile
    avg_HH_size = sum(Household.size.F * Weights) / sum(Weights),  # Calculate average household size in each percentile
    total_population = sum(Household.size.F * Weights),  # Total population in each percentile
    weighted_num_households = sum(Weights)
  )

# Print the results
mpce_by_quintile_urban1 <- mpce_by_quintile_urban[, 1:4]

mpce_by_quintile_urban_pop <- mpce_by_quintile_urban[, c(1, 5:7)]

#print(xtable(mpce_by_quintile_urban1))
```

```{=latex}
\begin{table}[ht]
\centering
\begin{tabular}{lrrr}
  \hline
  quintile & min\_MPCE & avg\_MPCE & max\_MPCE \\ 
  \hline
  1 & 1429.27 & 3272.40 & 4141.74 \\ 
  2 & 4146.61 & 4851.21 & 5571.12 \\ 
  3 & 5572.55 & 6389.92 & 7241.09 \\ 
  4 & 7242.91 & 8551.26 & 10143.33 \\ 
  5 & 10146.35 & 15253.80 & 110937.66 \\ 
   \hline
\end{tabular}
\end{table}
```
## Population distribution - Urban Karnataka

```{r, echo = FALSE, warning=FALSE, message=FALSE}
colnames(mpce_by_quintile_urban_pop)[colnames(mpce_by_quintile_urban_pop) == "weighted_num_households"] <- "weighted_households"

#xtable(mpce_by_quintile_urban_pop)
```

```{=latex}
\begin{table}[ht]
\centering
\begin{tabular}{lrrr}
  \hline
  quintile & avg\_HH\_size & total\_population & weighted\_households \\ 
  \hline
  1 & 5.25 & 4248297.55 & 809080.53 \\ 
  2 & 4.23 & 4251698.75 & 1004387.90 \\ 
  3 & 3.64 & 4248068.46 & 1168216.22 \\ 
  4 & 3.20 & 4265401.29 & 1333896.06 \\ 
  5 & 2.26 & 4253545.98 & 1880897.38 \\ 
   \hline
\end{tabular}
\end{table}
```
## Plotting MPCE values

```{r, echo = FALSE, warning=FALSE, message=FALSE}

# Calculate the average MPCE for Urban and Rural sectors
Urban_avg_MPCE <- MPCE_Karnataka_Urban %>%
  summarise(avg_MPCE = sum(MPCE * Weights * Household.size.F) / sum(Weights * Household.size.F)) %>%
  pull(avg_MPCE)

Rural_avg_MPCE <- MPCE_Karnataka_Rural %>%
  summarise(avg_MPCE = sum(MPCE * Weights * Household.size.F) / sum(Weights * Household.size.F)) %>%
  pull(avg_MPCE)

# Combine the data
mpce_by_quintile_urban2 <- mpce_by_quintile_urban1 %>%
  mutate(Sector = "Urban")

mpce_by_quintile_rural2 <- mpce_by_quintile_rural1 %>%
  mutate(Sector = "Rural")

Final_MPCE1 <- rbind(mpce_by_quintile_rural2, mpce_by_quintile_urban2)

# Create the plot
p <- ggplot(Final_MPCE1, aes(x = quintile, y = avg_MPCE, fill = Sector)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "MPCE by Quintile for Rural and Urban Sectors",
       x = "Quintile",
       y = "MPCE (in Rs)") +
  theme(
    legend.title = element_blank(),
    plot.title = element_text(size = 20),      # Increase title font size
    axis.title.x = element_text(size = 16),    # Increase x-axis label font size
    axis.title.y = element_text(size = 16),    # Increase y-axis label font size
    axis.text.x = element_text(size = 14),     # Increase x-axis text size
    axis.text.y = element_text(size = 14)      # Increase y-axis text size
  ) +
  scale_fill_manual(values = c("Rural" = "blue", "Urban" = "red")) +
  theme(legend.title = element_blank()) +
  geom_hline(yintercept = Rural_avg_MPCE, color = "blue", linetype = "dashed", size = 1) +
  geom_hline(yintercept = Urban_avg_MPCE, color = "red", linetype = "dashed", size = 1)

# Print the plot
print(p)

```

## Variables of Interest (sent by Prayas)

The variables of interest have been categorised into 3 major blocks

-    Characterstics of the dwelling unit of households (building materials used, source of energy for cooking and lighting, source of drinking water)

-   Consumer goods ownership - Whether households possesed TV, mobiles, PC, Laptop, bikes, cars, trucks, washing machine, AC, cooler, etc.

-   Appliances and transport equipment purchases - Number of first hand and second hand purchases, cost of purchases, cost of repair and maintenance, etc for goods identified above.

## MASTER_DATA

Master_Data.R in SRC/ provides the code for creating the requisite tables for each of the 3 blocks that is stored in DATA/.

Problem identified - There are exact number of rows as many as households in first 2 tables, however in 3rd table there are multiple rows for each household based on goods owned and its details. That's why kept these tables separately.

If details of each good is required, then the table remains as it is, however if we only need sub total for appliances and transport or the number of goods owned by each household, the table can be minimized to have same number of rows as the number of households.
